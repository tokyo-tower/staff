<%- include('./_step', {currentStepName: 'tickets'}) %>

<input type="hidden" id="input_maxq" name="maxq" value="<%= conf.get('reservation_maxq') %>">

<h1 class="pagetitle"><%- __('h1.SelectTickets') %></h1>
<p class="guidetext"><%- __('Label.SelectTicketsGuideText') %></p>
<% if (message) { %>
<p class="guidetext" style="color:red;"><%= message %></p>
<% } %>

<a class="link-guide" href="https://www.tokyotower.co.jp/price/" target="_blank"><%- __('Label.AboutTicket') %></a>
<!--<p class="guidetext"><%- __('Label.AboutTOPDECKTicket') %></p>-->
<div class="wrapper-2clm">
    <div class="clm-left" data-token="">
        <table class="table table-tickets">
            <thead>
                <tr>
                    <% /* 券種 */ %>
                    <th><%- __('Label.TicketType') %></th>
                    <% /* 枚数 */ %>
                    <th><%- __('Label.TicketCount') %></th>
                </tr>
            </thead>
            <tbody>
                <% /* スタッフ予約時 => 券種ごとの予約メモを回収 */
                    const memosByTicketType = {};
                    if (reservationModel.purchaserGroup === ReservationUtil.PURCHASER_GROUP_STAFF) {
                        reservationModel.seatCodes.forEach((seatCode) => {
                            let reservation = reservationModel[`reservation_${seatCode}`]
                            let ticketId = reservation.ticket_type;
                            if (typeof memosByTicketType[ticketId] !== 'string') {
                                memosByTicketType[ticketId] = reservation.watcher_name;
                            }
                        });
                    }
                %>
                <% /* 券種分loop */ %>
                <% reservationModel.ticketTypes.forEach(function(ticketType) { %>
                <tr data-ticket-code="<%- ticketType._id %>" data-ticket-charge="<%= ticketType.charge %>">
                    <% /* 券種名+値段 */ %>
                    <th>
                        <span><%- ticketType.name[locale] %> \<%= ticketType.charge %></span>
                        <%
                            /* スタッフ予約時 => 予約メモ欄を表示 */
                            if (reservationModel.purchaserGroup === ReservationUtil.PURCHASER_GROUP_STAFF) {
                        %>
                            <input type="text" name="watcherName" class="form-control" placeholder="予約メモ" value="<%- memosByTicketType[ticketType._id] %>">
                        <% } %>
                    </th>
                    <td>
                        <% /* 枚数選択dropdown */ %>
                        <select class="form-control">
                            <% for (let ticketCount = 0; ticketCount < 11; ticketCount++) { %>
                                <option value="<%- ticketCount.toString() %>"<% if (ticketCount === ticketType.count) { %> selected="selected"<% } %>><%- ticketCount.toString() %></option>
                            <% } %>
                        </select>
                    </td>
                </tr>
                <% }); %>
            </tbody>
            <% /* 合計金額 */ %>
            <tfoot class="hidden">
                <tr><td colspan="2">
                    <%- __('Label.TotalCharge') %><span class="price"></span>
                </td></tr>
            </tfoot>
        </table>
    </div>

    <div class="clm-right">
        <%- include('./_reservationModel') %>
    </div>

</div>

<form method="post">
    <input type="hidden" name="choices">
</form>

<p class="alert-ticket alert-ticket-overmax">選択出来る枚数は <%= conf.get('reservation_maxq') %>枚 までとなります。</p>

<script src="/js/reserve/tickets.js"></script>
